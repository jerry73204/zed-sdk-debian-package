# Maintainer: Hsiang-Jui Lin <jerry73204@gmail.com>
# PKGBUILD for generic ARM64 systems (non-Jetson)

pkgname=zed-sdk
pkgver=5.0.5
pkgrel=1
pkgdesc="StereoLabs ZED SDK for ARM64 systems"
arch=('arm64')
url="https://www.stereolabs.com/developers/release/"
license=('custom')

# Extract major.minor version for wheel downloads (5.0.5 -> 5.0)
_ver_major_minor=$(echo ${pkgver} | cut -d. -f1-2)

# ARM64 specific files (generic ARM64, not Jetson)
run_file="ZED_SDK_Ubuntu22_cuda12.8_tensorrt10.9_v${pkgver}.zstd.run"
whl_file="pyzed-${_ver_major_minor}-cp310-cp310-linux_aarch64.whl"

depends=(
  # Core dependencies
  'libjpeg-turbo8'
  'libturbojpeg'
  'libusb-1.0-0'
  'libusb-1.0-0-dev'
  'libopenblas-dev'
  'libarchive-dev'
  'libv4l-0'
  'curl'
  'unzip'
  'zlib1g'
  'mesa-utils'
  # Development dependencies
  'libpng-dev'
  # Qt dependencies for tools
  'qtbase5-dev'
  'qtchooser'
  'qt5-qmake'
  'qtbase5-dev-tools'
  'libqt5opengl5'
  'libqt5svg5'
  # OpenGL dependencies for samples
  'libglew-dev'
  'freeglut3-dev'
  # Python dependencies
  'python3-numpy'
  'python3-requests'
  'python3-pyqt5'
)

makedepends=(
  'zstd'
  'tar'
  'python3-dev'
  'python3-pip'
  'python3-setuptools'
)

# Note: libv4l-dev is NOT conflicted for generic ARM64
conflicts=()

options=('!strip')
postinst='postinst.sh'
prerm='prerm.sh'
postrm='postrm.sh'

source=(
  "${run_file}::https://download.stereolabs.com/zedsdk/5.0/cu12/ubuntu22"
  "${whl_file}::https://download.stereolabs.com/zedsdk/${_ver_major_minor}/whl/linux_aarch64/${whl_file}"
  "python_shebang.patch"
  "zed_ai_optimizer"
  "postinst.sh"
  "prerm.sh"
  "postrm.sh"
)

noextract=(
  "${whl_file}"
)

# Note: Using SKIP for ARM64 as we may not have the exact files
sha256sums=(
  'SKIP'
  'SKIP'
  '1eed77b1cb24af3e58ecffde7a6bd1524215efeb9bafdc9364a2add2bc911fcd'
  '3b521098392097553a949fc5bbb8c420ad9eb0888a447533aa494a1949646a4e'
  'SKIP'
  'SKIP'
  'SKIP'
)

prepare() {
  cd "${srcdir}"
  
  # Extract content from the self-extracting archive
  # The number 718 is the line where the binary data starts in the run file
  mkdir -p extract
  tail -n +718 "../${run_file}" | zstdcat -d | tar -xf - -C extract
  
  cd extract
  patch -Np1< "${srcdir}/python_shebang.patch"
}

package() {
  cd "${srcdir}/extract"
  
  # Create target directories
  mkdir -p "${pkgdir}/usr/local/zed"
  mkdir -p "${pkgdir}/usr/local/zed/settings"
  mkdir -p "${pkgdir}/usr/local/lib/python3.10/dist-packages"
  mkdir -p "${pkgdir}/etc/udev/rules.d"
  mkdir -p "${pkgdir}/etc/ld.so.conf.d"
  mkdir -p "${pkgdir}/usr/local/bin"
  mkdir -p "${pkgdir}/usr/share/licenses/${pkgname}"
  
  # Install license
  install -Dm644 "doc/license/LICENSE.txt" "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
  
  # Install ZED libraries and includes
  cp -a -t "${pkgdir}/usr/local/zed" lib
  cp -a -t "${pkgdir}/usr/local/zed" include
  
  # Install firmware and resources
  cp -a -t "${pkgdir}/usr/local/zed" firmware
  
  # Install cmake files
  install -Dm644 "zed-config.cmake" "${pkgdir}/usr/local/zed/zed-config.cmake"
  install -Dm644 "zed-config-version.cmake" "${pkgdir}/usr/local/zed/zed-config-version.cmake"
  
  # Install Python API script
  install -Dm755 "get_python_api.py" "${pkgdir}/usr/local/zed/get_python_api.py"
  
  # Install AI optimizer script
  install -Dm755 "${srcdir}/zed_ai_optimizer" "${pkgdir}/usr/local/bin/zed_ai_optimizer"
  
  # Install tools
  cp -a -t "${pkgdir}/usr/local/zed" tools
  
  # Create symlinks for tools
  find "${pkgdir}/usr/local/zed/tools/" -type f -executable | while read tool_exe; do
      name="$(basename $tool_exe)"
      ln -s "/usr/local/zed/tools/$name" "${pkgdir}/usr/local/bin/$(basename $tool_exe)"
  done
  
  # Install samples
  cp -a -t "${pkgdir}/usr/local/zed" samples
  
  # Install udev rules
  install -Dm644 "99-slabs.rules" "${pkgdir}/etc/udev/rules.d/99-slabs.rules"
  
  # Create and install ld.so.conf.d file with priority naming
  echo "/usr/local/zed/lib" > "${srcdir}/001-zed.conf"
  install -Dm644 "${srcdir}/001-zed.conf" "${pkgdir}/etc/ld.so.conf.d/001-zed.conf"
  
  # Create the doc directory
  cp -a -t "${pkgdir}/usr/local/zed" doc
  
  # Install Python wheel
  python3 -m pip install --no-deps --root="${pkgdir}" --prefix=/usr \
    --ignore-installed "${srcdir}/${whl_file}"
}