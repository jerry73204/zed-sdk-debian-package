# Maintainer: Hsiang-Jui Lin <jerry73204@gmail.com>
pkgname=python3-pyzed
pkgver=5.0.7
pkgrel=1
pkgdesc="Python bindings for StereoLabs ZED SDK"
arch=('amd64')
url="https://www.stereolabs.com/developers/release/"
license=('custom')

depends=(
  'zed-sdk'
  'python3'
  'python3-numpy'
  'python3-requests'
)

makedepends=(
  'python3-pip'
  'python3-setuptools'
)

whl_file="pyzed-5.0-cp310-cp310-linux_x86_64.whl"

source=(
    "${whl_file}::https://download.stereolabs.com/zedsdk/5.0/whl/linux_x86_64/pyzed-5.0-cp310-cp310-linux_x86_64.whl"
)

noextract=(
    "${whl_file}"
)

sha256sums=(
    '63bec817760df7efacba82399d46412e874f18f92b2227d88376130ba2c35598'
)

package() {
  cd "${srcdir}"

  # Install the Python wheel (pip will install to /usr/local/lib by default)
  python3 -m pip install --no-deps --root="${pkgdir}" --prefix=/usr \
		--ignore-installed --no-compile "${whl_file}"

  # Move from /usr/local/lib to /usr/lib for Debian convention
  # Debian/Ubuntu Python packages go in /usr/lib/python3/dist-packages
  mkdir -p "${pkgdir}/usr/lib/python3/dist-packages"
  if [ -d "${pkgdir}/usr/local/lib/python3.10/dist-packages/pyzed" ]; then
    mv "${pkgdir}/usr/local/lib/python3.10/dist-packages/pyzed"* \
       "${pkgdir}/usr/lib/python3/dist-packages/"
    # Remove empty directories
    rm -rf "${pkgdir}/usr/local"
  fi

  # Remove direct_url.json to avoid $srcdir reference warning
  find "${pkgdir}" -name "direct_url.json" -delete

  # Recompile Python cache files to remove $pkgdir references
  python3 -m compileall -q -f -d /usr "${pkgdir}/usr/lib/python3/dist-packages/pyzed" || true

  # Install license (get from zed-sdk package or include separately)
  # For now, we'll create a simple license file pointing to the main package
  mkdir -p "${pkgdir}/usr/share/licenses/${pkgname}"
  echo "This package shares the license with zed-sdk package." > "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
  echo "See /usr/share/licenses/zed-sdk/LICENSE for full license text." >> "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}
