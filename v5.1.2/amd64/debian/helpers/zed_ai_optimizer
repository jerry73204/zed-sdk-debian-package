#!/usr/bin/env bash
# ZED SDK AI Model Optimizer
# This script downloads and optimizes AI models for the ZED SDK
# The optimization process is platform-specific and can take a long time

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check if running as root
check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo -e "${RED}Error: This script must be run as root (use sudo)${NC}"
        exit 1
    fi
}

# Check if ZED SDK is installed
check_zed_sdk() {
    if [ ! -d "/opt/zed" ]; then
        echo -e "${RED}Error: ZED SDK not found at /opt/zed${NC}"
        echo "Please install the zed-sdk package first."
        exit 1
    fi
    
    if ! command -v ZED_Diagnostic &> /dev/null; then
        echo -e "${RED}Error: ZED_Diagnostic tool not found${NC}"
        echo "Please ensure the ZED SDK is properly installed."
        exit 1
    fi
}

# Display help message
show_help() {
    echo "ZED SDK AI Model Optimizer"
    echo "=========================="
    echo ""
    echo "This script downloads and optimizes AI models for the ZED SDK."
    echo "The optimization process is platform-specific (uses GPU/NPU when available)"
    echo "and can take 30-60 minutes depending on your hardware."
    echo ""
    echo "Usage: sudo $0 [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  -h, --help           Show this help message"
    echo "  -a, --all            Download and optimize all AI models (default)"
    echo "  -d, --download-only  Download models without optimization"
    echo "  -o, --optimize-only  Optimize already downloaded models"
    echo "  -n, --neural         Optimize all neural depth modes"
    echo "  -c, --clean          Remove all downloaded AI models"
    echo "  -s, --status         Check current AI models status"
    echo "  -q, --quiet          Suppress progress output"
    echo ""
    echo "Model-specific options:"
    echo "  --multi-class        Multi-class detection models"
    echo "  --person-head        Person head detection models"
    echo "  --body-tracking      Body tracking models"
    echo "  --neural-depth       Neural depth estimation models"
    echo ""
    echo "Examples:"
    echo "  sudo $0              # Download and optimize all models"
    echo "  sudo $0 -d           # Download all models without optimization"
    echo "  sudo $0 --neural     # Optimize neural depth modes only"
    echo "  sudo $0 -c           # Clean all AI models"
}

# Check model status
check_status() {
    echo -e "${BLUE}Checking AI model status...${NC}"
    echo ""
    
    # Check if models directory exists
    if [ -d "/opt/zed/resources" ]; then
        echo "Models directory: /opt/zed/resources"
        if [ -d "/opt/zed/resources/models" ]; then
            echo -e "${GREEN}Found models directory${NC}"
            echo "Current models:"
            ls -lh /opt/zed/resources/models 2>/dev/null || echo "  No models found"
        else
            echo -e "${YELLOW}No models directory found${NC}"
        fi
    else
        echo -e "${YELLOW}Resources directory not found${NC}"
    fi
    echo ""
}

# Download all AI models
download_all() {
    echo -e "${BLUE}Downloading all AI models...${NC}"
    echo "This may take several minutes depending on your internet connection."
    echo ""
    
    if [ "$QUIET" = false ]; then
        ZED_Diagnostic -aid
    else
        ZED_Diagnostic -aid > /dev/null 2>&1
    fi
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}✓ AI models downloaded successfully${NC}"
    else
        echo -e "${RED}✗ Failed to download AI models${NC}"
        exit 1
    fi
}

# Optimize all AI models
optimize_all() {
    echo -e "${BLUE}Optimizing all AI models for your platform...${NC}"
    echo -e "${YELLOW}⚠ This process can take 30-60 minutes depending on your hardware${NC}"
    echo -e "${YELLOW}⚠ The system may become less responsive during optimization${NC}"
    echo ""
    
    # Detect platform
    ARCH=$(uname -m)
    if [ -f /etc/nv_tegra_release ]; then
        echo "Platform: NVIDIA Jetson (${ARCH})"
        echo "Optimization will use NPU/DLA when available"
    elif [ "$ARCH" = "x86_64" ]; then
        echo "Platform: x86_64"
        if nvidia-smi &> /dev/null; then
            echo "NVIDIA GPU detected - will use GPU acceleration"
        else
            echo "No NVIDIA GPU detected - will use CPU (slower)"
        fi
    else
        echo "Platform: ${ARCH}"
    fi
    echo ""
    
    echo "Starting optimization..."
    if [ "$QUIET" = false ]; then
        ZED_Diagnostic -aio
    else
        ZED_Diagnostic -aio > /dev/null 2>&1
    fi
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}✓ AI models optimized successfully${NC}"
    else
        echo -e "${RED}✗ Failed to optimize AI models${NC}"
        exit 1
    fi
}

# Optimize neural depth modes
optimize_neural() {
    echo -e "${BLUE}Optimizing neural depth modes...${NC}"
    echo ""
    
    echo "1. Optimizing NEURAL mode..."
    ZED_Diagnostic -nrlo
    
    echo "2. Optimizing NEURAL_PLUS mode..."
    ZED_Diagnostic -nrlo_plus
    
    echo "3. Optimizing NEURAL_LIGHT mode..."
    ZED_Diagnostic -nrlo_light
    
    echo -e "${GREEN}✓ Neural depth modes optimized${NC}"
}

# Clean all AI models
clean_models() {
    echo -e "${YELLOW}Removing all AI models...${NC}"
    
    read -p "Are you sure you want to remove all AI models? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Cancelled."
        exit 0
    fi
    
    ZED_Diagnostic -aic
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}✓ AI models removed successfully${NC}"
    else
        echo -e "${RED}✗ Failed to remove AI models${NC}"
        exit 1
    fi
}

# Main script
main() {
    local ACTION="all"
    QUIET=false
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_help
                exit 0
                ;;
            -a|--all)
                ACTION="all"
                shift
                ;;
            -d|--download-only)
                ACTION="download"
                shift
                ;;
            -o|--optimize-only)
                ACTION="optimize"
                shift
                ;;
            -n|--neural)
                ACTION="neural"
                shift
                ;;
            -c|--clean)
                ACTION="clean"
                shift
                ;;
            -s|--status)
                ACTION="status"
                shift
                ;;
            -q|--quiet)
                QUIET=true
                shift
                ;;
            *)
                echo -e "${RED}Unknown option: $1${NC}"
                echo "Use -h or --help for usage information"
                exit 1
                ;;
        esac
    done
    
    # Check prerequisites
    if [ "$ACTION" != "status" ]; then
        check_root
    fi
    check_zed_sdk
    
    # Display header
    if [ "$QUIET" = false ]; then
        echo "======================================"
        echo "    ZED SDK AI Model Optimizer"
        echo "======================================"
        echo ""
    fi
    
    # Execute action
    case $ACTION in
        all)
            check_status
            download_all
            echo ""
            optimize_all
            echo ""
            echo -e "${GREEN}✓ All AI models have been downloaded and optimized${NC}"
            echo "Your ZED SDK is now ready to use AI features!"
            ;;
        download)
            download_all
            ;;
        optimize)
            optimize_all
            ;;
        neural)
            optimize_neural
            ;;
        clean)
            clean_models
            ;;
        status)
            check_status
            ;;
    esac
    
    echo ""
    echo "Done!"
}

# Run main function
main "$@"